
<!DOCTYPE html>
<html>
<head>
    <title>Simple Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbsmA32HUIm2uIaBIAiuKM6L0vM86cRxI&callback=initMap&v=weekly" defer></script>
    <style>
        #map {
            height: 80vh;
            background-color: red;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script>

        let map, marker, infoWindow, circle, punto, idWatchPosition;
        const coord=[]

        var cant=0
        async function xxx(){
                        await fetch("https://632491505c1b435727ab8796.mockapi.io/deiby/ubicacion/1")
                            .then(response => response.json())
                            .then(async json => {
                                console.log(json); 
                                console.log("Solicitudes: "+(cant+=1))
                                const pos = {
                                    lat: json.latitude,
                                    lng: json.longitude,
                                };
                                circle.setCenter(pos)
                                circle.setRadius(json.accuracy/2/*Math.sqrt(position.coords.accuracy) * 100*/)
                                punto.setPosition(pos)
                                map.setCenter(pos);
                                await xxx()
                            })
                            .catch(async err => {
                                console.log(err);
                                console.log("Solicitudes: "+(cant+=1))
                                await xxx()
                            }
                        )
                    }
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -17.738267, lng: -63.087960 },
                zoom: 13,
            });
                        const directionsService = new google.maps.DirectionsService();
                        const directionsRenderer = new google.maps.DirectionsRenderer({
                            draggable: true,
                            map,
                        });
            infoWindow = new google.maps.InfoWindow();
            marker = new google.maps.Marker({
                position:  { lat: -17.738267, lng: -63.087960 },
                map,
                title: 'Hello World!',
            })
            circle = new google.maps.Circle({
                strokeColor: "#blue",
                strokeOpacity: 0.9,
                strokeWeight: 0.2,
                fillColor: "blue",
                fillOpacity: 0.1,
                map,
            });
            punto=new google.maps.Marker({
                //position: map.getCenter(),
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                },
                map: map,
            });
            map.addListener("click", (e) => {
                var valorActivo = document.querySelector('input[name="Componentes"]:checked').value;
                if(valorActivo=="Seleccionar"){
                    
                }
                else if(valorActivo=="Marcador"){
                    marker.setPosition({lat: e.latLng.lat(), lng: e.latLng.lng()});
                }
                else if(valorActivo=="Ubicacion"){
                    xxx()
                }
                
                else if(valorActivo=="Direcciones"){
                    coord.push({lat: e.latLng.lat(), lng: e.latLng.lng()})
                    if(coord.length>1){
                        directionsRenderer.changed()
                        directionsRenderer.addListener("directions_changed", () => {
                            //const directions = directionsRenderer.getDirections();
                            const i=Object.keys(directionsRenderer.gm_bindings_.markerOptions)[0];
                            ////console.log(Object.keys(directionsRenderer.gm_bindings_.markerOptions[i].ek))
                            console.log(directionsRenderer.gm_bindings_.markerOptions[i].ek['markers'])
                            //console.log(directionsRenderer)
                        });
                        //console.log(coord)
                        let puntos=[]
                        for (let i = 1; i < coord.length-1; i++) {
                            puntos.push({location: coord[i].lat+', '+ coord[i].lng, stopover:false});
                        }
                        directionsService
                            .route({
                                origin: coord[0],
                                destination: coord[coord.length-1], 
                                waypoints: puntos,
                                travelMode: google.maps.TravelMode.DRIVING,
                                avoidTolls: false,
                                provideRouteAlternatives: false,
                            })
                            .then((response) => {
                                directionsRenderer.setDirections(response);
                            })
                            .catch((e) => window.alert("Directions request failed due to " + e));
                    }
                    else if(coord.length>2){
                        coord.splice(0, coord.length-1)
                    }
                }
                /*CODIGO BETA PARA PROGRAMAR EL BORRADO DE ALGUN WAYPOINT
                else if(valorActivo=="x"){
                    const i=Object.keys(directionsRenderer.gm_bindings_.markerOptions)[0];
                    console.log(i);
                    console.log(directionsRenderer.gm_bindings_.markerOptions[i].ek['markers']);
                    let mark=directionsRenderer.gm_bindings_.markerOptions[i].ek['markers']
                    //mark[0].setPosition({lat: -17.738267, lng: -63.087960});
                    mark[1].addListener("click", (e) => {
                        alert()
                    })
                }*/
            });
        }
        window.initMap = initMap;
    </script>
    <!--<link rel="stylesheet" type="text/css" href="../Styles/index.css" />
    <script type="module" src="../Scripts/index.js"></script>-->
    
    
</head>
<body>
    <div id="map"></div>
    <input type='radio' name="Componentes" value="Seleccionar"/>
    <label>Seleccionar</label><br>
    <input type='radio' name="Componentes" value="Marcador"/>
    <label>Marcador</label><br>
    <input type='radio' name="Componentes" value="Ubicacion" checked/>
    <label>Ubicacion</label><br>
    <input type='radio' name="Componentes" value="Direcciones"/>
    <label>Direcciones</label><br>
    <script src="./Scripts/consola.js"></script>
</body>
</html>
